"use strict";(()=>{async function y(n){return new Promise(e=>setTimeout(e,n))}function h(n){console.error("%o",n)}async function c(n){let e=await fetch(n);if(!e.ok)throw Error(`Failed to fetch ${n}: ${e.statusText}`);return await e.json()}function M(n,e=100){let t=[],r=0;return()=>{switch(t.length){case 0:{let s=(async()=>{let i=Date.now();i<r+e&&await y(r+e-i),r=Date.now();try{await n()}finally{t.shift()}})();return t.push(s),s}case 1:{let s=t[0],i=(async()=>{await s,await y(e),r=Date.now();try{await n()}finally{t.shift()}})();return t.push(i),i}case 2:return t[1];default:throw Error(`Unexpected state: promiceses=${t.length.toString()}`)}}}var C={en:"english",de:"german",es:"spanish",fr:"french",it:"italian",ja:"japanese",ko:"koreana",pl:"polish",pt:"brazilian",ru:"russian",tr:"turkish","zh-CN":"schinese","zh-TW":"tchinese"},N=["blocks","prefabs","shapes"],l=class n{static DEFAULT_LANGUAGE="english";#e;#r;#i;#t;constructor(e,t){this.#e=e,this.#r=A(t),this.#i=new Map(N.map(r=>[r,this.#a(n.DEFAULT_LANGUAGE,r)])),this.#t=this.#n()}get(e){let t=this.#t.get(e);if(!t)throw new Error(`No labels for ${this.#r}/${e}`);return t}set language(e){e!==this.#r&&(console.log("LabelHolder set language: %s -> %s",this.#r,e),this.#r=e,this.#t=this.#n())}#n(){return new Map(N.map(e=>[e,this.#s(e)]))}async#s(e){let t=this.#i.get(e);if(!t)throw new Error(`No fallback for ${this.#r}/${e}`);return new P(await this.#a(this.#r,e),await t)}async#a(e,t){return new Map(Object.entries(await c(`${this.#e}/${e}/${t}.json`)))}},P=class{#e;#r;constructor(e,t){this.#e=e,this.#r=t}get(e){return this.#e.get(e)??this.#r.get(e)}};function A(n){for(let e of n)for(let[t,r]of Object.entries(C))if(e.startsWith(t))return r;return l.DEFAULT_LANGUAGE}var u=Symbol("NO_VALUE"),f=class{#e;#r;#i;#t=u;#n=null;#s=null;#a=Date.now();constructor(e,t,r=1e4){this.#e=e,this.#r=t,this.#i=r}async get(){try{return this.#t===u?await this.#o():this.#t}finally{this.#h()}}async#o(){if(this.#n)return this.#n;this.#n=this.#l();try{this.#t=await this.#n}finally{this.#n=null}return this.#t}async#l(){let e,t;do e=Date.now(),t=await this.#e();while(e<this.#a);return t}invalidate(){this.#t!==u&&(this.#r(this.#t),this.#t=u),this.#s&&clearTimeout(this.#s),this.#s=null,this.#a=Date.now()}#h(){this.#s&&clearTimeout(this.#s),this.#s=setTimeout(()=>{this.invalidate()},this.#i)}};var g=class extends Error{#e;constructor(e){super("Multiple errors occurred"),this.#e=e}get causes(){return this.#e}};var d=class{#e=[];addListener(e){this.#e.push(e)}removeListener(e){let t=this.#e.indexOf(e);t>=0&&this.#e.splice(t,1)}async dispatch(e){let r=(await Promise.allSettled(this.#e.map(s=>s(e)))).flatMap(s=>s.status==="rejected"?[s.reason]:[]);if(r.length===1)throw r[0];if(r.length>1)throw new g(r)}dispatchNoAwait(e){this.dispatch(e).catch(h)}};var p=class{#e;#r;#i=[];#t=[];#n="";#s=new d;#a=[];all=[];markCoords=null;difficulty={start:0,end:5};prefabFilterRegexp="";blockFilterRegexp="";constructor(e,t,r){this.#e=new l(e,t),this.#r=new f(r,()=>{})}set language(e){this.#e.language=e}set preExcludes(e){this.#a=e.map(t=>new RegExp(t))}update=M(()=>this.updateImmediately());async updateImmediately(){await this.#l(),this.#o(),this.#d(),this.#m(),await this.#s.dispatch({update:{status:this.#n,prefabs:this.#t}})}#o(){this.prefabFilterRegexp.length===0&&this.blockFilterRegexp.length===0&&this.difficulty.start===0&&this.difficulty.end===5?this.#n=`All ${this.#i.length.toString()} prefabs`:this.#t.length===0?this.#n="No prefabs matched":this.#n=`${this.#t.length.toString()} prefabs matched`}addListener(e){this.#s.addListener(e)}async#l(){this.#i=this.#h(this.all);let e=this.#c(this.#i);e=await this.#u(e),e=await this.#f(e),this.#t=e}#h(e){return e.filter(t=>{for(let r of this.#a)if(r.test(t.name))return!1;return!0})}#c(e){return e.filter(t=>{let r=t.difficulty??0;return r>=this.difficulty.start&&r<=this.difficulty.end})}async#u(e){let t=await this.#e.get("prefabs"),r=new RegExp(this.prefabFilterRegexp,"i");return e.flatMap(s=>{let i=t.get(s.name);if(this.prefabFilterRegexp.length===0)return{...s,highlightedName:s.name,highlightedLabel:i??"-"};let o=m(s.name,r),a=i&&m(i,r);return o!=null||a!=null?{...s,highlightedName:o??s.name,highlightedLabel:a??i??"-"}:[]})}async#f(e){if(this.blockFilterRegexp.length===0)return e;let t=await this.#g(e);return e.flatMap(r=>{let s=t[r.name];return s?{...r,matchedBlocks:s}:[]})}async#g(e){let t=await this.#e.get("blocks"),r=await this.#e.get("shapes"),s=new Set(e.map(a=>a.name)),i={},o=new RegExp(this.blockFilterRegexp,"i");for(let[a,T]of Object.entries(await this.#r.get())){let E=m(a,o),w=t.get(a)??r.get(a)??"-",k=w&&m(w,o);if(!(E==null&&k==null))for(let[x,v]of Object.entries(T))s.has(x)&&(i[x]=(i[x]??[]).concat({name:a,highlightedName:E??a,highlightedLabel:k??w,count:v}))}return i}#d(){if(this.markCoords){let{markCoords:e}=this;this.#t.forEach(t=>t.distance=[$(t,e),G(t,e)])}else this.#t.forEach(e=>e.distance=null)}#m(){this.all.length===0?this.#n="No prefabs loaded":this.#t.length===0?this.#n+=". Please relax the filter conditions":this.markCoords?(this.#n+=", order by distances from the flag",this.#t.sort(B)):this.blockFilterRegexp.length>0?(this.#n+=", order by counts of matched blocks",this.#t.sort(F)):this.#t.sort(b)}};function b(n,e){let t=n.difficulty??0,r=e.difficulty??0;return t===r?n.name.localeCompare(e.name):r-t}function F(n,e){if(!n.matchedBlocks||!e.matchedBlocks)return b(n,e);let t=n.matchedBlocks.reduce((s,i)=>s+(i.count??0),0),r=e.matchedBlocks.reduce((s,i)=>s+(i.count??0),0);return t===r?b(n,e):r-t}function B(n,e){return!n.distance||!e.distance||n.distance[1]===e.distance[1]?b(n,e):n.distance[1]-e.distance[1]}function G(n,e){return Math.round(Math.sqrt((n.x-e.x)**2+(n.z-e.z)**2))}function $(n,e){let t=n.x-e.x,r=n.z-e.z;if(t===0&&r===0)return null;let s=Math.atan2(r,t)*180/Math.PI;return s<-157.5||s>=157.5?"W":s<-112.5?"SW":s<-67.5?"S":s<-22.5?"SE":s<22.5?"E":s<67.5?"NE":s<112.5?"N":"NW"}function m(n,e){let t=!1,r=n.replace(e,s=>(t=s.length>0,`<mark>${s}</mark>`));return t?r:null}var L=new p("../labels",navigator.languages,async()=>U(await c("../prefab-block-counts.json")));onmessage=({data:n})=>{console.log("Prefab-filter received message: ",n),Object.assign(L,n).update().catch(h)};L.addListener(n=>{console.log("Prefab-filter send message: ",n),postMessage(n)});function U(n){let e={};for(let[t,r]of Object.entries(n))for(let[s,i]of Object.entries(r))e[s]=Object.assign(e[s]??{},{[t]:i});return e}})();
//# sourceMappingURL=prefabs-filter.js.map
