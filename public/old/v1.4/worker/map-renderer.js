"use strict";(()=>{async function d(a){return new Promise(e=>setTimeout(e,a))}function g(a){return{type:"game",...a}}function y(a){console.error("%o",a)}function v(a,e=100){let t=[],n=0;return()=>{switch(t.length){case 0:{let i=(async()=>{let s=Date.now();s<n+e&&await d(n+e-s),n=Date.now();try{await a()}finally{t.shift()}})();return t.push(i),i}case 1:{let i=t[0],s=(async()=>{await i,await d(e),n=Date.now();try{await a()}finally{t.shift()}})();return t.push(s),s}case 2:return t[1];default:throw Error(`Unexpected state: promiceses=${t.length.toString()}`)}}}var E="workspace";async function S(){let a=await navigator.storage.getDirectory();return new w(await a.getDirectoryHandle(E,{create:!0}))}var w=class{#e;constructor(e){this.#e=e}get name(){return this.#e.name}async put(e,t){console.debug("put",e);let i=await(await this.#e.getFileHandle(e,{create:!0})).createWritable();t instanceof ArrayBuffer||t instanceof Blob?await i.write(t):await t.pipeTo(i),await i.close()}async createWritable(e){return await(await this.#e.getFileHandle(e,{create:!0})).createWritable()}async get(e){console.debug("get",e);try{return await(await this.#e.getFileHandle(e)).getFile()}catch(t){if(t instanceof DOMException&&t.name==="NotFoundError")return null;throw t}}async size(e){return(await(await this.#e.getFileHandle(e)).getFile()).size}async remove(e){await this.#e.removeEntry(e)}};var u=Symbol("NO_VALUE"),f=class{#e;#r;#s;#t=u;#a=null;#n=null;#i=Date.now();constructor(e,t,n=1e4){this.#e=e,this.#r=t,this.#s=n}async get(){try{return this.#t===u?await this.#o():this.#t}finally{this.#c()}}async#o(){if(this.#a)return this.#a;this.#a=this.#l();try{this.#t=await this.#a}finally{this.#a=null}return this.#t}async#l(){let e,t;do e=Date.now(),t=await this.#e();while(e<this.#i);return t}invalidate(){this.#t!==u&&(this.#r(this.#t),this.#t=u),this.#n&&clearTimeout(this.#n),this.#n=null,this.#i=Date.now()}#c(){this.#n&&clearTimeout(this.#n),this.#n=setTimeout(()=>{this.invalidate()},this.#s)}};var x="\u2718",M="\u{1F6A9}",m=class{brightness="100%";markerCoords=null;scale=.1;showPrefabs=!0;prefabs=[];signSize=200;signAlpha=1;biomesAlpha=1;splat3Alpha=1;splat4Alpha=1;radAlpha=1;canvas;#e=g({width:0,height:0});#r=new h("biomes.png");#s=new h("splat3.png");#t=new h("splat4.png");#a=new h("radiation.png");#n=[this.#r,this.#s,this.#t,this.#a];#i;constructor(e,t){this.canvas=e,this.#i=t}set invalidate(e){for(let t of e)switch(t){case"biomes.png":this.#r.invalidate();break;case"splat3.png":this.#s.invalidate();break;case"splat4.png":this.#t.invalidate();break;case"radiation.png":this.#a.invalidate();break;default:throw new Error(`Invalid file name: ${String(t)}`)}}update=v(async()=>{console.log("MapUpdate"),console.time("MapUpdate"),await this.#o(),console.timeEnd("MapUpdate")});async#o(){let[e,t,n,i]=await Promise.all(this.#n.map(c=>c.get())),{width:s,height:o}=k(e,t,n,i);if(this.#e.width=s,this.#e.height=o,s===0||o===0){this.canvas.width=1,this.canvas.height=1;return}this.canvas.width=s*this.scale,this.canvas.height=o*this.scale;let r=this.canvas.getContext("2d");r&&(r.imageSmoothingEnabled=!1,r.scale(this.scale,this.scale),r.filter=`brightness(${this.brightness})`,e&&this.biomesAlpha!==0&&(r.globalAlpha=this.biomesAlpha,r.drawImage(e,0,0,s,o)),r.imageSmoothingEnabled=!0,t&&this.splat3Alpha!==0&&(r.globalAlpha=this.splat3Alpha,r.drawImage(t,0,0,s,o)),n&&this.splat4Alpha!==0&&(r.globalAlpha=this.splat4Alpha,r.drawImage(n,0,0,s,o)),r.imageSmoothingEnabled=!1,r.filter="none",i&&this.radAlpha!==0&&(r.globalAlpha=this.radAlpha,r.drawImage(i,0,0,s,o)),r.globalAlpha=this.signAlpha,this.showPrefabs&&this.drawPrefabs(r,s,o),this.markerCoords&&this.drawMark(r,s,o))}drawPrefabs(e,t,n){e.font=`${this.signSize.toString()}px '${this.#i[x]}'`,e.fillStyle="red",e.textAlign="center",e.textBaseline="middle";let i=t/2,s=n/2,o=Math.round(this.signSize*.01),r=Math.round(this.signSize*.05);for(let c of this.prefabs.toReversed()){let p=i+c.x+o,T=s-c.z+r;A(e,{text:x,x:p,z:T,size:this.signSize})}}drawMark(e,t,n){if(!this.markerCoords)return;e.font=`${this.signSize.toString()}px '${this.#i[M]}'`,e.fillStyle="red",e.textAlign="left",e.textBaseline="alphabetic";let i=t/2,s=n/2,o=-1*Math.round(this.signSize*.32),r=-1*Math.round(this.signSize*.1),c=i+this.markerCoords.x+o,p=s-this.markerCoords.z+r;A(e,{text:M,x:c,z:p,size:this.signSize})}size(){return this.#e}};function k(...a){return g({width:Math.max(...a.map(e=>e?.width??0)),height:Math.max(...a.map(e=>e?.height??0))})}function A(a,{text:e,x:t,z:n,size:i}){a.lineWidth=Math.round(i*.2),a.strokeStyle="rgba(0, 0, 0, 0.8)",a.strokeText(e,t,n),a.lineWidth=Math.round(i*.1),a.strokeStyle="white",a.strokeText(e,t,n),a.fillText(e,t,n)}var h=class extends f{constructor(t){super(async()=>{console.log("Loading image",t);let i=await(await S()).get(t);try{return i?await createImageBitmap(i):null}finally{console.log("Loaded image",t)}},n=>n?.close());this.fileName=t}};var l=null,b={"Noto Sans Symbols 2":new FontFace("Noto Sans Symbols 2","url('../NotoSansSymbols2.subset.woff2') format('woff2')"),"Noto Emoji Old":new FontFace("Noto Emoji Old","url('../NotoEmojiOld.subset.woff2') format('woff2')")};Promise.all(Object.values(b).map(async a=>{await a.load(),self.fonts.add(a),l&&(await l.update(),postMessage({mapSize:l.size()})),console.log("map-renderer: loaded font",a)})).catch(y);var F={"\u2718":b["Noto Sans Symbols 2"].family,"\u{1F6A9}":b["Noto Emoji Old"].family};onmessage=async a=>{let e=a.data;if(console.log("map-renderer: recieved %o",e),!l)if(e.canvas)l=new m(e.canvas,F);else throw Error("Unexpected state");await Object.assign(l,e).update();let t={mapSize:l.size()};console.log("map-renderer: sending %o",t),postMessage(t)};})();
//# sourceMappingURL=map-renderer.js.map
