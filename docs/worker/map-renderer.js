(()=>{"use strict";var t={934:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ImageBitmapHolder=void 0;const a=i(726);e.ImageBitmapHolder=class{constructor(t,e,i=1e4){var s;this.fallbackPromise=null,this.lastAccessAt=0,this.label=t,(s=e)instanceof Blob&&"image/png"===s.type.toLowerCase()?this._png=e:(this._png=a.imageBitmapToPngBlob(e),this.setImg(e)),this.imgAge=i}async get(){return this.lastAccessAt=Date.now(),this.img??this.fallbackPromise??this.getFallback()}async getFallback(){return this.fallbackPromise=this.getImageBitmap(),this.fallbackPromise}async getImageBitmap(){console.debug("Fallback",this.label);const t=await createImageBitmap(await this._png);return this.setImg(t),this.fallbackPromise=null,t}setImg(t){this.img=t,setTimeout((()=>this.expireImage()),this.imgAge)}expireImage(){Date.now()-this.lastAccessAt>this.imgAge?(console.debug("Expire",this.label),a.requireNonnull(this.img).close(),this.img=null):setTimeout((()=>this.expireImage()),this.imgAge)}}},407:function(t,e,i){var a=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=i(934),n=a(i(847)),l="ðŸš©ï¸";function o(t,{text:e,x:i,z:a,size:s}){t.lineWidth=Math.round(.2*s),t.strokeStyle="rgba(0, 0, 0, 0.8)",t.strokeText(e,i,a),t.lineWidth=Math.round(.1*s),t.strokeStyle="white",t.strokeText(e,i,a),t.fillText(e,i,a)}e.default=class{constructor(t,e){this.brightness="100%",this.markerCoords=null,this.scale=.1,this.showPrefabs=!0,this.prefabs=[],this.signSize=200,this.signAlpha=1,this.biomesAlpha=1,this.splat3Alpha=1,this.splat4Alpha=1,this.radAlpha=1,this.throttledUpdater=n.default((()=>this.updateImmediately())),this._biomesImg=null,this._splat3Img=null,this._splat4Img=null,this._radImg=null,this.canvas=t,this.fontFace=e}set biomesImg(t){this._biomesImg=t?new s.ImageBitmapHolder("biomes",t):null}set splat3Img(t){this._splat3Img=t?new s.ImageBitmapHolder("splat3",t):null}set splat4Img(t){this._splat4Img=t?new s.ImageBitmapHolder("splat4",t):null}set radImg(t){this._radImg=t?new s.ImageBitmapHolder("rad",t):null}async inGameSize(){const t=await Promise.all([this._biomesImg?.get(),this._splat3Img?.get(),this._splat4Img?.get()]);return{width:Math.max(...t.map((t=>t?.width??0))),height:Math.max(...t.map((t=>t?.height??0)))}}async update(){await this.throttledUpdater()}isBlank(){return!this._biomesImg&&!this._splat3Img&&!this._splat4Img}async updateImmediately(){if(console.time("Map Update"),this.isBlank())return this.canvas.width=1,void(this.canvas.height=1);const{width:t,height:e}=await this.inGameSize();this.canvas.width=t*this.scale,this.canvas.height=e*this.scale;const i=this.canvas.getContext("2d");i&&(i.scale(this.scale,this.scale),i.filter=`brightness(${this.brightness})`,this._biomesImg&&0!==this.biomesAlpha&&(i.globalAlpha=this.biomesAlpha,i.drawImage(await this._biomesImg.get(),0,0,t,e)),this._splat3Img&&0!==this.splat3Alpha&&(i.globalAlpha=this.splat3Alpha,i.drawImage(await this._splat3Img.get(),0,0,t,e)),this._splat4Img&&0!==this.splat4Alpha&&(i.globalAlpha=this.splat4Alpha,i.drawImage(await this._splat4Img.get(),0,0,t,e)),i.filter="none",this._radImg&&0!==this.radAlpha&&(i.globalAlpha=this.radAlpha,i.imageSmoothingEnabled=!1,i.drawImage(await this._radImg.get(),0,0,t,e),i.imageSmoothingEnabled=!0),i.globalAlpha=this.signAlpha,this.showPrefabs&&this.drawPrefabs(i,t,e),this.markerCoords&&this.drawMark(i,t,e),console.timeEnd("Map Update"))}drawPrefabs(t,e,i){t.font=`${this.signSize}px ${this.fontFace?.family??""}`,t.fillStyle="red",t.textAlign="center",t.textBaseline="middle";const a=e/2,s=i/2,n=Math.round(.01*this.signSize),l=Math.round(.05*this.signSize);for(let e=this.prefabs.length-1;e>=0;e-=1){const i=this.prefabs[e];o(t,{text:"âœ˜",x:a+i.x+n,z:s-i.z+l,size:this.signSize})}}drawMark(t,e,i){if(!this.markerCoords)return;t.font=`${this.signSize}px ${this.fontFace?.family??""}`,t.fillStyle="red",t.textAlign="left",t.textBaseline="alphabetic";const a=e/2,s=i/2,n=-1*Math.round(.32*this.signSize),r=-1*Math.round(.1*this.signSize),h=a+this.markerCoords.x+n,m=s-this.markerCoords.z+r;o(t,{text:l,x:h,z:m,size:this.signSize}),t.strokeText(l,h,m),t.fillText(l,h,m)}}},847:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0});const a=i(726);e.default=function(t){let e=!1,i=null;return async()=>{e=!0,i||(i=(async()=>{for(;e;)e=!1,await t(),await a.waitAnimationFrame();i=null})())}}},726:(t,e)=>{function i(t,e=(()=>`Unexpected state: ${t}`)){if(t)return t;throw Error(e())}function a(t,e,i=(()=>`Unexpected type: ${t}`)){if(t instanceof e)return t;throw Error(i())}Object.defineProperty(e,"__esModule",{value:!0}),e.imageBitmapToPngBlob=e.downloadCanvasPng=e.formatCoords=e.waitAnimationFrame=e.humanreadableDistance=e.removeAllChildren=e.component=e.requireType=e.requireNonnull=void 0,e.requireNonnull=i,e.requireType=a,e.component=function(t,e){const s=i(document.getElementById(i(t,(()=>`Element ID must not null: ${t}`))),(()=>`Element not found: #${t}`));return e?a(s,e):s},e.removeAllChildren=function(t){for(;t.lastChild;)t.removeChild(t.lastChild)},e.humanreadableDistance=function(t){return t<1e3?`${t}m`:`${(t/1e3).toFixed(2)}km`},e.waitAnimationFrame=function(){return new Promise((t=>requestAnimationFrame(t)))},e.formatCoords=function(t,e,i,a){if(!a)return"E/W: -, N/S: -, Elev: -";const s=a.offsetX*t.width/e.width,n=a.offsetY*t.height/e.height;return s<0||s>=t.width||n<0||n>=t.height?"E/W: -, N/S: -, Elev: -":`E/W: ${Math.round(s-t.width/2)}, N/S: ${Math.round(t.height/2-n)}, Elev: ${i({x:Math.round(s),z:Math.round(n)},t.width)??"-"}`},e.downloadCanvasPng=function(t,e){const i=document.createElement("a");i.download=t,i.href=e.toDataURL("image/png"),i.click()},e.imageBitmapToPngBlob=async function(t){const e=new OffscreenCanvas(t.height,t.width);return i(e.getContext("2d")).drawImage(t,0,0),await e.convertToBlob({type:"image/png"})}},179:function(t,e,i){var a=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=a(i(407)),n=new FontFace("Noto Sans","url(../NotoEmoji-Regular.ttf)");let l=null;n.load().then((()=>{fonts.add(n),l?.update()})),onmessage=async t=>{const e=t.data;if(console.debug(e),!l){if(!e.canvas)throw Error("Unexpected state");l=new s.default(e.canvas,n)}await Object.assign(l,e).update(),postMessage({mapSize:await l.inGameSize()})}}},e={};!function i(a){var s=e[a];if(void 0!==s)return s.exports;var n=e[a]={exports:{}};return t[a].call(n.exports,n,n.exports,i),n.exports}(179)})();
//# sourceMappingURL=map-renderer.js.map